#!/usr/bin/env bash

#
## Colors
#

COLOR_WHITE="\[\033[1;37m\]"
COLOR_LIGHTGRAY="\[\033[0;37m\]"
COLOR_GRAY="\[\033[1;30m\]"
COLOR_BLACK="\[\033[0;30m\]"
COLOR_RED="\[\033[0;31m\]"
COLOR_LIGHTRED="\[\033[1;31m\]"
COLOR_GREEN="\[\033[0;32m\]"
COLOR_LIGHTGREEN="\[\033[1;32m\]"
COLOR_BROWN="\[\033[0;33m\]"
COLOR_YELLOW="\[\033[1;33m\]"
COLOR_BLUE="\[\033[0;34m\]"
COLOR_LIGHTBLUE="\[\033[1;34m\]"
COLOR_PURPLE="\[\033[0;35m\]"
COLOR_PINK="\[\033[1;35m\]"
COLOR_CYAN="\[\033[0;36m\]"
COLOR_LIGHTCYAN="\[\033[1;36m\]"
COLOR_DEFAULT="\[\033[0m\]"

function set_temp_color() {
   echo "$1$2$COLOR_DEFAULT"
}

function colorize_number {
   num=$1
   if [ $num -gt 0 ]; then
      color=""
      if [ $num -gt 2 ]; then
         color=$COLOR_RED
      else
         color=$COLOR_YELLOW
      fi

      echo "$(set_temp_color $color $num)"
   fi
}

function get_bg_jobs() {
   job_count=$(colorize_number $(jobs -r | wc -l))

   echo ${job_count:+" (bg: $job_count)"}
}

function get_stopped_jobs() {
   job_count=$(colorize_number $(jobs -s | wc -l))

   echo ${job_count:+" (stopped: $job_count)"}
}

function parse_git_branch {
   local branch=$(git branch --no-color 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/')

   if [ -n "$branch" ]; then
      local modified=$(git diff --quiet 2> /dev/null || echo " (mod)")
      local staged=$(git diff --staged --quiet 2> /dev/null || echo " (staged)")
      local stash_size=$(git stash list 2> /dev/null | wc -l)

      local clr_branch=$(set_temp_color $COLOR_LIGHTGREEN "$branch")
      local clr_modified=$(set_temp_color $COLOR_RED "$modified")
      local clr_staged=$(set_temp_color $COLOR_BLUE "$staged")
      local clr_stash=""

      if [ $stash_size -gt 0 ]; then
         clr_stash=" (stash: $(colorize_number $stash_size))"
      fi

      echo " (git: ${clr_branch}${clr_modified}${clr_staged}${clr_stash})"
   fi
}

function dirs_stack_size {
   cur_count=$(dirs -p | wc -l)

   if [ $cur_count -gt 1 ]; then
      echo " (dirs: $(colorize_number $(($cur_count - 1))))"
   fi
}

function detached_screens {
   local screen_bin=$(which screen)
   local detached_count=$($screen_bin -list | grep -c "(Detached)")
   local color=""

   if [ $detached_count -gt 0 ]; then
      if [ $detached_count -gt 1 ]; then
         color=$COLOR_RED
      else
         color=$COLOR_YELLOW
      fi

   fi

   if [ "$detached_count" != "0" ]; then
      echo " (sd: $(set_temp_color $color $detached_count))"
   fi
}

function prompt_command() {
   P_USER=$(set_temp_color $COLOR_GREEN "\u")
   P_HOST=$(set_temp_color $COLOR_GREEN"\h")
   P_DIR=$(set_temp_color $COLOR_LIGHTCYAN "\w")
   P_DSTACK=$(dirs_stack_size)
   P_BG_JOBS=$(get_bg_jobs)
   P_STOPPED_JOBS=$(get_stopped_jobs)
   P_GIT_BRANCH=$(parse_git_branch)
   P_DETACHED_SCREEN=$(detached_screens)

   PS1="${P_USER}@${P_HOST}:${P_DIR}${P_BG_JOBS}${P_STOPPED_JOBS}${P_DSTACK}${P_DETACHED_SCREEN}${P_GIT_BRANCH}\$ "
}

#
# Set prompt
#

export PROMPT_COMMAND=prompt_command

